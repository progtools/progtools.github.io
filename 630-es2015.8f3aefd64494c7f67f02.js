(self.webpackChunkprog_tools=self.webpackChunkprog_tools||[]).push([[630],{630:function(e,t,i){"use strict";i.r(t),i.d(t,{QrModule:function(){return C}});var r=i(1095),n=i(8583),s=i(5987),o=i(5310),a=i(5917);let c=(()=>{class e{static hasCamera(){return navigator.mediaDevices?navigator.mediaDevices.enumerateDevices().then(e=>e.some(e=>"videoinput"===e.kind)).catch(()=>!1):Promise.resolve(!1)}constructor(t,i,r=this._onDecodeError.bind(this),n=e.DEFAULT_CANVAS_SIZE,s="environment"){this.$video=t,this.$canvas=document.createElement("canvas"),this._onDecode=i,this._preferredFacingMode=s,this._active=!1,this._paused=!1,this._flashOn=!1,"number"==typeof r?(n=r,console.warn("You're using a deprecated version of the QrScanner constructor which will be removed in the future")):this._onDecodeError=r,this.$canvas.width=n,this.$canvas.height=n,this._sourceRect={x:0,y:0,width:n,height:n},this._updateSourceRect=this._updateSourceRect.bind(this),this._onPlay=this._onPlay.bind(this),this._onVisibilityChange=this._onVisibilityChange.bind(this),this.$video.playsInline=!0,this.$video.muted=!0,this.$video.disablePictureInPicture=!0,this.$video.addEventListener("loadedmetadata",this._updateSourceRect),this.$video.addEventListener("play",this._onPlay),document.addEventListener("visibilitychange",this._onVisibilityChange),this._qrEnginePromise=e.createQrEngine()}hasFlash(){if(!("ImageCapture"in window))return Promise.resolve(!1);const e=this.$video.srcObject?this.$video.srcObject.getVideoTracks()[0]:null;return e?new ImageCapture(e).getPhotoCapabilities().then(e=>e.fillLightMode.includes("flash")).catch(e=>(console.warn(e),!1)):Promise.reject("Camera not started or not available")}isFlashOn(){return this._flashOn}toggleFlash(){return this._setFlash(!this._flashOn)}turnFlashOff(){return this._setFlash(!1)}turnFlashOn(){return this._setFlash(!0)}destroy(){this.$video.removeEventListener("loadedmetadata",this._updateSourceRect),this.$video.removeEventListener("play",this._onPlay),document.removeEventListener("visibilitychange",this._onVisibilityChange),this.stop(),e._postWorkerMessage(this._qrEnginePromise,"close")}start(){if(this._active&&!this._paused)return Promise.resolve();if("https:"!==window.location.protocol&&console.warn("The camera stream is only accessible if the page is transferred via https."),this._active=!0,this._paused=!1,document.hidden)return Promise.resolve();if(clearTimeout(this._offTimeout),this._offTimeout=null,this.$video.srcObject)return this.$video.play(),Promise.resolve();let e=this._preferredFacingMode;return this._getCameraStream(e,!0).catch(()=>(e="environment"===e?"user":"environment",this._getCameraStream())).then(t=>{e=this._getFacingMode(t)||e,this.$video.srcObject=t,this.$video.play(),this._setVideoMirror(e)}).catch(e=>{throw this._active=!1,e})}stop(){this.pause(),this._active=!1}pause(){this._paused=!0,this._active&&(this.$video.pause(),this._offTimeout||(this._offTimeout=setTimeout(()=>{const e=this.$video.srcObject?this.$video.srcObject.getTracks():[];for(const t of e)t.stop();this.$video.srcObject=null,this._offTimeout=null},300)))}static scanImage(t,i=null,r=null,n=null,s=!1,o=!1){const a=r instanceof Worker;let c=Promise.all([r||e.createQrEngine(),e._loadImage(t)]).then(([t,o])=>{let c;return r=t,[n,c]=this._drawToCanvas(o,i,n,s),r instanceof Worker?(a||r.postMessage({type:"inversionMode",data:"both"}),new Promise((t,i)=>{let s,o,a;o=n=>{"qrResult"===n.data.type&&(r.removeEventListener("message",o),r.removeEventListener("error",a),clearTimeout(s),null!==n.data.data?t(n.data.data):i(e.NO_QR_CODE_FOUND))},a=e=>{r.removeEventListener("message",o),r.removeEventListener("error",a),clearTimeout(s),i("Scanner error: "+(e?e.message||e:"Unknown Error"))},r.addEventListener("message",o),r.addEventListener("error",a),s=setTimeout(()=>a("timeout"),1e4);const h=c.getImageData(0,0,n.width,n.height);r.postMessage({type:"decode",data:h},[h.data.buffer])})):new Promise((t,i)=>{const s=setTimeout(()=>i("Scanner error: timeout"),1e4);r.detect(n).then(r=>{r.length?t(r[0].rawValue):i(e.NO_QR_CODE_FOUND)}).catch(e=>i("Scanner error: "+(e.message||e))).finally(()=>clearTimeout(s))})});return i&&o&&(c=c.catch(()=>e.scanImage(t,null,r,n,s))),c=c.finally(()=>{a||e._postWorkerMessage(r,"close")}),c}setGrayscaleWeights(t,i,r,n=!0){e._postWorkerMessage(this._qrEnginePromise,"grayscaleWeights",{red:t,green:i,blue:r,useIntegerApproximation:n})}setInversionMode(t){e._postWorkerMessage(this._qrEnginePromise,"inversionMode",t)}static createQrEngine(t=e.WORKER_PATH){return("BarcodeDetector"in window?BarcodeDetector.getSupportedFormats():Promise.resolve([])).then(e=>-1!==e.indexOf("qr_code")?new BarcodeDetector({formats:["qr_code"]}):new Worker(t))}_onPlay(){this._updateSourceRect(),this._scanFrame()}_onVisibilityChange(){document.hidden?this.pause():this._active&&this.start()}_updateSourceRect(){const e=Math.min(this.$video.videoWidth,this.$video.videoHeight),t=Math.round(2/3*e);this._sourceRect.width=this._sourceRect.height=t,this._sourceRect.x=(this.$video.videoWidth-t)/2,this._sourceRect.y=(this.$video.videoHeight-t)/2}_scanFrame(){if(!this._active||this.$video.paused||this.$video.ended)return!1;requestAnimationFrame(()=>{this.$video.readyState<=1?this._scanFrame():this._qrEnginePromise.then(t=>e.scanImage(this.$video,this._sourceRect,t,this.$canvas,!0)).then(this._onDecode,t=>{this._active&&(-1!==(t.message||t).indexOf("service unavailable")&&(this._qrEnginePromise=e.createQrEngine()),this._onDecodeError(t))}).then(()=>this._scanFrame())})}_onDecodeError(t){t!==e.NO_QR_CODE_FOUND&&console.log(t)}_getCameraStream(e,t=!1){const i=[{width:{min:1024}},{width:{min:768}},{}];return e&&(t&&(e={exact:e}),i.forEach(t=>t.facingMode=e)),this._getMatchingCameraStream(i)}_getMatchingCameraStream(e){return navigator.mediaDevices&&0!==e.length?navigator.mediaDevices.getUserMedia({video:e.shift()}).catch(()=>this._getMatchingCameraStream(e)):Promise.reject("Camera not found.")}_setFlash(e){return this.hasFlash().then(t=>t?this.$video.srcObject.getVideoTracks()[0].applyConstraints({advanced:[{torch:e}]}):Promise.reject("No flash available")).then(()=>this._flashOn=e)}_setVideoMirror(e){this.$video.style.transform="scaleX("+("user"===e?-1:1)+")"}_getFacingMode(e){const t=e.getVideoTracks()[0];return t?/rear|back|environment/i.test(t.label)?"environment":/front|user|face/i.test(t.label)?"user":null:null}static _drawToCanvas(e,t=null,i=null,r=!1){i=i||document.createElement("canvas");const n=t&&t.x?t.x:0,s=t&&t.y?t.y:0,o=t&&t.width?t.width:e.width||e.videoWidth,a=t&&t.height?t.height:e.height||e.videoHeight;r||i.width===o&&i.height===a||(i.width=o,i.height=a);const c=i.getContext("2d",{alpha:!1});return c.imageSmoothingEnabled=!1,c.drawImage(e,n,s,o,a,0,0,i.width,i.height),[i,c]}static _loadImage(t){if(t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement||window.ImageBitmap&&t instanceof window.ImageBitmap||window.OffscreenCanvas&&t instanceof window.OffscreenCanvas)return Promise.resolve(t);if(t instanceof Image)return e._awaitImageLoad(t).then(()=>t);if(t instanceof File||t instanceof Blob||t instanceof URL||"string"==typeof t){const i=new Image;return i.src=t instanceof File||t instanceof Blob?URL.createObjectURL(t):t,e._awaitImageLoad(i).then(()=>((t instanceof File||t instanceof Blob)&&URL.revokeObjectURL(i.src),i))}return Promise.reject("Unsupported image type.")}static _awaitImageLoad(e){return new Promise((t,i)=>{if(e.complete&&0!==e.naturalWidth)t();else{let r,n;r=()=>{e.removeEventListener("load",r),e.removeEventListener("error",n),t()},n=()=>{e.removeEventListener("load",r),e.removeEventListener("error",n),i("Image load error")},e.addEventListener("load",r),e.addEventListener("error",n)}})}static _postWorkerMessage(e,t,i){return Promise.resolve(e).then(e=>{e instanceof Worker&&e.postMessage({type:t,data:i})})}}return e.DEFAULT_CANVAS_SIZE=400,e.NO_QR_CODE_FOUND="No QR code found",e.WORKER_PATH="qr-scanner-worker.min.js",e})();var h=i(8307),d=i(3190),l=i(5304),m=i(7716),u=i(6758);const g=["cropComponent"];function v(e,t){if(1&e&&(m.TgZ(0,"div",4),m._uU(1),m.qZA()),2&e){const e=m.oxw();m.xp6(1),m.Oqu(e.qrResult)}}function p(e,t){1&e&&(m.TgZ(0,"div"),m._uU(1," Please wait while we scan for a qr code in the image...\n"),m.qZA())}function f(e,t){if(1&e){const e=m.EpF();m.TgZ(0,"div"),m.TgZ(1,"app-image-crop",6,7),m.NdJ("croppedImage",function(t){return m.CHM(e),m.oxw(2).onImageCrop(t)}),m.qZA(),m.TgZ(3,"button",8),m.NdJ("click",function(){return m.CHM(e),m.oxw(2).onCropClicked()}),m._uU(4," CROP "),m.qZA(),m.qZA()}if(2&e){const e=m.oxw(2);m.xp6(1),m.Q6J("imageData",e.errImg.imageData)}}function _(e,t){if(1&e&&(m.TgZ(0,"div",5),m._uU(1),m.YNc(2,f,5,1,"div",1),m.qZA()),2&e){const e=m.oxw();m.xp6(1),m.hij(" ",e.qrError,". If you think the image contains qr code please crop the image to just contain the qr Code. Use the red box below over the image to select the qr portion and click on the crop button at the bottom of the image. "),m.xp6(1),m.Q6J("ngIf",e.errImg)}}c.WORKER_PATH="/assets/service-workers/qr-scanner-worker.min.js";const w=[{path:"",component:(()=>{class e{constructor(e){this.cdr=e,this.isScanning=!1}set content(e){this.cropComponent=e}ngOnInit(){}onError(e,t){return(0,a.of)(t).pipe((0,h.b)(e=>{this.qrError="Unable to find qr code in the image",console.warn(e)}),(0,d.w)(()=>o.i.convertFileToImageBase64(e)),(0,h.b)(e=>this.errImg=e))}onErrorB64(e,t){return(0,a.of)(t).pipe((0,h.b)(e=>{this.qrError="Unable to find qr code in the image",console.warn(e)}),(0,h.b)(()=>this.errImg={imageData:e}))}scanFile(e){(0,a.of)(1).pipe((0,h.b)(()=>{this.qrError=this.qrResult="",this.isScanning=!0,this.cdr.detectChanges()}),(0,d.w)(()=>c.scanImage(e)),(0,h.b)(e=>this.qrResult=e),(0,l.K)(t=>this.onError(e,t)),(0,h.b)(()=>{this.isScanning=!1,this.cdr.detectChanges()})).subscribe()}scanFileB64(e){(0,a.of)(1).pipe((0,h.b)(()=>{this.qrError=this.qrResult="",this.isScanning=!0,this.cdr.detectChanges()}),(0,d.w)(()=>{const t=document.createElement("img");return t.src=e,c.scanImage(t)}),(0,h.b)(e=>this.qrResult=e),(0,l.K)(t=>this.onErrorB64(e,t)),(0,h.b)(()=>{this.isScanning=!1,this.cdr.detectChanges()})).subscribe()}fileChanged(e){this.scanFile(e.target.files[0])}onImageCrop(e){this.scanFileB64(e)}onCropClicked(){this.cropComponent&&this.cropComponent.cropImage()}}return e.\u0275fac=function(t){return new(t||e)(m.Y36(m.sBO))},e.\u0275cmp=m.Xpm({type:e,selectors:[["app-qr"]],viewQuery:function(e,t){if(1&e&&m.Gf(g,5),2&e){let e;m.iGM(e=m.CRH())&&(t.content=e.first)}},decls:5,vars:3,consts:[["class","success",4,"ngIf"],[4,"ngIf"],["class","error",4,"ngIf"],["type","file","accept","image/*",3,"change"],[1,"success"],[1,"error"],[3,"imageData","croppedImage"],["cropComponent",""],["mat-raised-button","","mat-primary","",3,"click"]],template:function(e,t){1&e&&(m.YNc(0,v,2,1,"div",0),m.YNc(1,p,2,0,"div",1),m.YNc(2,_,3,2,"div",2),m._uU(3,"\nUpload image with QR code\n"),m.TgZ(4,"input",3),m.NdJ("change",function(e){return t.fileChanged(e)}),m.qZA()),2&e&&(m.Q6J("ngIf",t.qrResult),m.xp6(1),m.Q6J("ngIf",t.isScanning),m.xp6(1),m.Q6J("ngIf",t.qrError&&!t.isScanning))},directives:[n.O5,u.d,r.lW],styles:[".success[_ngcontent-%COMP%]{color:rgba(25,102,63,.582)}.error[_ngcontent-%COMP%]{color:red}"],changeDetection:0}),e})()}];let b=(()=>{class e{}return e.\u0275fac=function(t){return new(t||e)},e.\u0275mod=m.oAB({type:e}),e.\u0275inj=m.cJS({imports:[[s.Bz.forChild(w)],s.Bz]}),e})();var E=i(712);let C=(()=>{class e{}return e.\u0275fac=function(t){return new(t||e)},e.\u0275mod=m.oAB({type:e}),e.\u0275inj=m.cJS({imports:[[n.ez,E.K,b,r.ot]]}),e})()}}]);